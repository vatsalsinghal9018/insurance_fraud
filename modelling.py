final_col_list=['InsuredAge',
 'CapitalGains',
 'CapitalLoss',
 'InsuredGender_FEMALE',
 'InsuredGender_MALE',
 'InsuredEducationLevel_Associate',
 'InsuredEducationLevel_College',
 'InsuredEducationLevel_High School',
 'InsuredEducationLevel_JD',
 'InsuredEducationLevel_MD',
 'InsuredEducationLevel_Masters',
 'InsuredEducationLevel_PhD',
 'InsuredOccupation_adm-clerical',
 'InsuredOccupation_armed-forces',
 'InsuredOccupation_craft-repair',
 'InsuredOccupation_exec-managerial',
 'InsuredOccupation_farming-fishing',
 'InsuredOccupation_handlers-cleaners',
 'InsuredOccupation_machine-op-inspct',
 'InsuredOccupation_other-service',
 'InsuredOccupation_priv-house-serv',
 'InsuredOccupation_prof-specialty',
 'InsuredOccupation_protective-serv',
 'InsuredOccupation_sales',
 'InsuredOccupation_tech-support',
 'InsuredOccupation_transport-moving',
 'InsuredHobbies_base-jumping',
 'InsuredHobbies_basketball',
 'InsuredHobbies_board-games',
 'InsuredHobbies_bungie-jumping',
 'InsuredHobbies_camping',
 'InsuredHobbies_chess',
 'InsuredHobbies_cross-fit',
 'InsuredHobbies_dancing',
 'InsuredHobbies_exercise',
 'InsuredHobbies_golf',
 'InsuredHobbies_hiking',
 'InsuredHobbies_kayaking',
 'InsuredHobbies_movies',
 'InsuredHobbies_paintball',
 'InsuredHobbies_polo',
 'InsuredHobbies_reading',
 'InsuredHobbies_skydiving',
 'InsuredHobbies_sleeping',
 'InsuredHobbies_video-games',
 'InsuredHobbies_yachting',
 'Country_India',
 'CustomerLoyaltyPeriod',
 'Policy_Deductible',
 'PolicyAnnualPremium',
 'UmbrellaLimit',
 'InsurancePolicyState_State1',
 'InsurancePolicyState_State2',
 'InsurancePolicyState_State3',
 'Policy_CombinedSingleLimit_100/1000',
 'Policy_CombinedSingleLimit_100/300',
 'Policy_CombinedSingleLimit_100/500',
 'Policy_CombinedSingleLimit_250/1000',
 'Policy_CombinedSingleLimit_250/300',
 'Policy_CombinedSingleLimit_250/500',
 'Policy_CombinedSingleLimit_500/1000',
 'Policy_CombinedSingleLimit_500/300',
 'Policy_CombinedSingleLimit_500/500',
 'InsuredRelationship_husband',
 'InsuredRelationship_not-in-family',
 'InsuredRelationship_other-relative',
 'InsuredRelationship_own-child',
 'InsuredRelationship_unmarried',
 'InsuredRelationship_wife',
 'IncidentTime',
 'NumberOfVehicles',
 'BodilyInjuries',
 'AmountOfTotalClaim',
 'AmountOfInjuryClaim',
 'AmountOfPropertyClaim',
 'AmountOfVehicleDamage',
 'TypeOfIncident_Multi-vehicle Collision',
 'TypeOfIncident_Parked Car',
 'TypeOfIncident_Single Vehicle Collision',
 'TypeOfIncident_Vehicle Theft',
 'TypeOfCollission_Front Collision',
 'TypeOfCollission_Rear Collision',
 'TypeOfCollission_Side Collision',
 'SeverityOfIncident_Major Damage',
 'SeverityOfIncident_Minor Damage',
 'SeverityOfIncident_Total Loss',
 'SeverityOfIncident_Trivial Damage',
 'AuthoritiesContacted_Ambulance',
 'AuthoritiesContacted_Fire',
 'AuthoritiesContacted_None',
 'AuthoritiesContacted_Other',
 'AuthoritiesContacted_Police',
 'IncidentState_State3',
 'IncidentState_State4',
 'IncidentState_State5',
 'IncidentState_State6',
 'IncidentState_State7',
 'IncidentState_State8',
 'IncidentState_State9',
 'IncidentCity_City1',
 'IncidentCity_City2',
 'IncidentCity_City3',
 'IncidentCity_City4',
 'IncidentCity_City5',
 'IncidentCity_City6',
 'IncidentCity_City7',
 'PropertyDamage_NO',
 'PropertyDamage_YES',
 'Witnesses_0',
 'Witnesses_1',
 'Witnesses_2',
 'Witnesses_3',
 'Witnesses_MISSINGVALUE',
 'PoliceReport_NO',
 'PoliceReport_YES',
 'VehicleAttributeDetails_VehicleMake_Accura',
 'VehicleAttributeDetails_VehicleMake_Audi',
 'VehicleAttributeDetails_VehicleMake_BMW',
 'VehicleAttributeDetails_VehicleMake_Chevrolet',
 'VehicleAttributeDetails_VehicleMake_Dodge',
 'VehicleAttributeDetails_VehicleMake_Ford',
 'VehicleAttributeDetails_VehicleMake_Honda',
 'VehicleAttributeDetails_VehicleMake_Jeep',
 'VehicleAttributeDetails_VehicleMake_Mercedes',
 'VehicleAttributeDetails_VehicleMake_Nissan',
 'VehicleAttributeDetails_VehicleMake_Saab',
 'VehicleAttributeDetails_VehicleMake_Suburu',
 'VehicleAttributeDetails_VehicleMake_Toyota',
 'VehicleAttributeDetails_VehicleMake_Volkswagen',
 'VehicleAttributeDetails_VehicleModel_3 Series',
 'VehicleAttributeDetails_VehicleModel_92x',
 'VehicleAttributeDetails_VehicleModel_93',
 'VehicleAttributeDetails_VehicleModel_95',
 'VehicleAttributeDetails_VehicleModel_A3',
 'VehicleAttributeDetails_VehicleModel_A5',
 'VehicleAttributeDetails_VehicleModel_Accord',
 'VehicleAttributeDetails_VehicleModel_C300',
 'VehicleAttributeDetails_VehicleModel_CRV',
 'VehicleAttributeDetails_VehicleModel_Camry',
 'VehicleAttributeDetails_VehicleModel_Civic',
 'VehicleAttributeDetails_VehicleModel_Corolla',
 'VehicleAttributeDetails_VehicleModel_E400',
 'VehicleAttributeDetails_VehicleModel_Escape',
 'VehicleAttributeDetails_VehicleModel_F150',
 'VehicleAttributeDetails_VehicleModel_Forrestor',
 'VehicleAttributeDetails_VehicleModel_Fusion',
 'VehicleAttributeDetails_VehicleModel_Grand Cherokee',
 'VehicleAttributeDetails_VehicleModel_Highlander',
 'VehicleAttributeDetails_VehicleModel_Impreza',
 'VehicleAttributeDetails_VehicleModel_Jetta',
 'VehicleAttributeDetails_VehicleModel_Legacy',
 'VehicleAttributeDetails_VehicleModel_M5',
 'VehicleAttributeDetails_VehicleModel_MDX',
 'VehicleAttributeDetails_VehicleModel_ML350',
 'VehicleAttributeDetails_VehicleModel_Malibu',
 'VehicleAttributeDetails_VehicleModel_Maxima',
 'VehicleAttributeDetails_VehicleModel_Neon',
 'VehicleAttributeDetails_VehicleModel_Passat',
 'VehicleAttributeDetails_VehicleModel_Pathfinder',
 'VehicleAttributeDetails_VehicleModel_RAM',
 'VehicleAttributeDetails_VehicleModel_RSX',
 'VehicleAttributeDetails_VehicleModel_Silverado',
 'VehicleAttributeDetails_VehicleModel_TL',
 'VehicleAttributeDetails_VehicleModel_Tahoe',
 'VehicleAttributeDetails_VehicleModel_Ultima',
 'VehicleAttributeDetails_VehicleModel_Wrangler',
 'VehicleAttributeDetails_VehicleModel_X5',
 'VehicleAttributeDetails_VehicleModel_X6',
 'no_days_incident_vehicleYOM',
 'no_days_incident_PolicyCoverage']

import pandas as pd
import numpy as np
import pickle
from sklearn.impute import SimpleImputer
from sklearn.preprocessing import OneHotEncoder
from sklearn.preprocessing import LabelEncoder
from sklearn.model_selection import train_test_split
from sklearn.metrics import auc, accuracy_score,f1_score,recall_score,precision_score, confusion_matrix, mean_squared_error,roc_curve, roc_auc_score
from sklearn.model_selection import cross_val_score, GridSearchCV, KFold, RandomizedSearchCV, train_test_split
import xgboost as xgb


def data_cleaning_demo(df):
    df = df.dropna(subset=['CustomerID'])
    # DEMOGRAPHICS
    if ('InsuredGender' in df.columns):
        df['InsuredGender'] = np.where(df['InsuredGender'] == 'NA', np.nan, df['InsuredGender'])

    if ('InsuredZipCode' in df.columns):
        df = df.drop(['InsuredZipCode'], axis=1)

    # POLICY INFO
    if ('InsurancePolicyNumber' in df.columns):
        df = df.drop(['InsurancePolicyNumber'], axis=1)

    if ('PolicyAnnualPremium' in df.columns):
        df['PolicyAnnualPremium'] = np.where(df['PolicyAnnualPremium'] == -1,
                                             np.nan, df['PolicyAnnualPremium'])
    if ('DateOfPolicyCoverage' in df.columns):
        df['DateOfPolicyCoverage'] = pd.to_datetime(df['DateOfPolicyCoverage'], format='%Y-%m-%d')

    # CLAIM
    if ('TypeOfCollission' in df.columns):
        df['TypeOfCollission'] = np.where(df['TypeOfCollission'] == '?',
                                          np.nan, df['TypeOfCollission'])
    if ('IncidentTime' in df.columns):
        df['IncidentTime'] = np.where(df['IncidentTime'] == -5,
                                      np.nan, df['IncidentTime'])
    if ('PropertyDamage' in df.columns):
        df['PropertyDamage'] = np.where(df['PropertyDamage'] == '?',
                                        np.nan, df['PropertyDamage'])
    if ('PoliceReport' in df.columns):
        df['PoliceReport'] = np.where(df['PoliceReport'] == '?',
                                      np.nan, df['PoliceReport'])
    if ('AmountOfTotalClaim' in df.columns):
        df['AmountOfTotalClaim'] = np.where(df['AmountOfTotalClaim'] == 'MISSEDDATA',
                                            np.nan, df['AmountOfTotalClaim'])
        df['AmountOfTotalClaim'] = df['AmountOfTotalClaim'].astype(float)

    if ('DateOfIncident' in df.columns):
        df['DateOfIncident'] = pd.to_datetime(df['DateOfIncident'], format='%Y-%m-%d')

    if ('IncidentAddress' in df.columns):
        df.drop(['IncidentAddress'], axis=1, inplace=True)

    # VEHICLE
    if ('VehicleAttributeDetails' in df.columns):
        df['VehicleAttributeDetails'] = np.where(df['VehicleAttributeDetails'] == '???',
                                                 np.nan, df['VehicleAttributeDetails'])

    return df


def post_processing(df_train, df_test):
    df_train_obj = df_train.select_dtypes(include=['object'])
    df_train_num = df_train.select_dtypes(exclude=['object', 'datetime'])
    df_train_datetime = df_train.select_dtypes(include=['datetime'])
    num_cols = df_train_num.columns.tolist()
    cat_cols = df_train_obj.columns.tolist()
    datetime_cols = df_train_datetime.columns.tolist()
    print("object columns ::", cat_cols)
    print("numeric columns ::", num_cols)
    print("datetime columns ::", datetime_cols)

    imp_mean = SimpleImputer(strategy='mean')
    imp_mode = SimpleImputer(strategy='most_frequent')
    if (len(num_cols)) > 0:
        df_train_num = pd.DataFrame(imp_mean.fit_transform(df_train_num), columns=df_train_num.columns)
    if (len(cat_cols)) > 0:
        df_train_obj = pd.DataFrame(imp_mode.fit_transform(df_train_obj), columns=df_train_obj.columns)

    df_train_pp = pd.concat([df_train_obj, df_train_num, df_train_datetime], axis=1)

    oh_enc = OneHotEncoder(handle_unknown='ignore')
    cat_cols_onc = [i for i in cat_cols if i not in ('CustomerID', 'InsuredZipCode')]
    if (len(cat_cols_onc) > 0):
        print("cat_cols_onc. ::", cat_cols_onc)
        df_train_enc = pd.DataFrame(oh_enc.fit_transform(df_train_pp[cat_cols_onc]).toarray(),
                                    columns=oh_enc.get_feature_names_out())
        df_train_pp = df_train_pp.drop(cat_cols_onc, axis=1)
        df_train_pp = pd.concat([df_train_pp, df_train_enc], axis=1)

    df_test_num = df_test[num_cols]
    df_test_obj = df_test[cat_cols]
    df_test_datetime = df_test[datetime_cols]

    if (len(num_cols)) > 0:
        df_test_num = pd.DataFrame(imp_mean.transform(df_test_num), columns=df_test_num.columns)
    if (len(cat_cols)) > 0:
        df_test_obj = pd.DataFrame(imp_mode.transform(df_test_obj), columns=df_test_obj.columns)

    df_test_pp = pd.concat([df_test_obj, df_test_num, df_test_datetime], axis=1)

    if (len(cat_cols_onc) > 0):
        df_test_enc = pd.DataFrame(oh_enc.transform(df_test_pp[cat_cols_onc]).toarray(),
                                   columns=oh_enc.get_feature_names_out())
        df_test_pp = df_test_pp.drop(cat_cols_onc, axis=1)
        df_test_pp = pd.concat([df_test_pp, df_test_enc], axis=1)

    return df_train_pp, df_test_pp

def read_output_predict():
    df_output=pd.read_csv('output.csv')
    df_output.drop(['CustomerID','pred'],axis=1,inplace=True)
    df_output=df_output[final_col_list]
    print(df_output.shape)
    # df_output.to_csv("input_to_model_test_df.csv")
    model=pickle.load( open('model.pkl','rb'))
    preds=model.predict(df_output)
    df_output['preds']=preds
    print(df_output['preds'].value_counts(normalize=True))


# read_output_predict()


